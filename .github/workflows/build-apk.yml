name: Build APK (TWA)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Bubblewrap
        run: npm i -g @bubblewrap/cli

      - name: Generate keystore (auto)
        run: |
          keytool -genkeypair -v \
            -keystore release.keystore \
            -storepass android \
            -keypass android \
            -alias release \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Maher alOmessi, OU=Dev, O=Maher, L=Yemen, S=YE, C=YE"

      - name: Build APK (non-interactive)
        env:
          KEYSTORE_PASSWORD: android
          KEY_PASSWORD: android
          KEY_ALIAS: release
        run: |
          SITE_URL="https://maheralomessi.github.io/dr-ahlam-prices-offline/"

          mkdir -p twa && cd twa

          # answer "n" to Bubblewrap JDK prompt to avoid interactive CI failure
          yes n | bubblewrap init \
            --manifest="${SITE_URL}manifest.webmanifest" \
            --directory="." \
            --packageId="com.dr.ahlam.prices" \
            --name="لائحة أسعار د. أحلام" \
            --launcherName="لائحة الأسعار" \
            --display="standalone" \
            --orientation="portrait" \
            --themeColor="#d4af37" \
            --backgroundColor="#ffffff" \
            --iconUrl="${SITE_URL}icons/icon-512.png" \
            --signingKeyPath="../release.keystore" \
            --signingKeyAlias="${KEY_ALIAS}" \
            --signingKeyPassword="${KEYSTORE_PASSWORD}" \
            --keyPassword="${KEY_PASSWORD}"

          bubblewrap build

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-apk
          path: twa/app-release-signed.apk
